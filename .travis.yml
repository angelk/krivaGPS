dist: bionic
language: minimal

services:
  - docker

jobs:
  include:
    - stage: docker tests
      name: Tests inside docker
      script: >-
        docker build --tag=trackhub-web ./docker/web/ &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "composer install --prefer-dist" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "yarn install" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "php -v" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "./vendor/bin/phpunit -c tests/phpunit/phpunit.xml --no-coverage" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "./bin/console doctrine:mapping:info" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "yarn encore dev" &&
        docker run -v `pwd`:/var/www -t trackhub-web /bin/bash -c "yarn encore production"
    - name: php cs tests
      script: >-
        docker run -v `pwd`:/var/www -t php:7 /bin/bash -c "
          cd /var/www &&
          php -r 'copy('https://getcomposer.org/installer', 'composer-setup.php');' &&
          php composer-setup.php &&
          php composer.phar install &&
          ./vendor/bin/phpcs --standard=phpcs.xml"

stages:
  - docker tests
  - php cs tests

notifications:
    on_success: never
    on_failure: never
    on_change: never
